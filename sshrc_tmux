# To avoid duplicated activation
# Source SSH settings, if applicable
AUTHSOCK_PREFIX=${HOME}/.ssh/auth_sock

function info(){
  echo $1 >&2
}

function echo_auth_sock_symlink(){
  username=$(whoami)
  if [[ $(uname -a) =~ Linux.*Microsoft ]];then
    # WSL
    fromwhere=$(hostname)
  else
    # mac or GNU/Linux
    login_info=($(last $username | head -n 1))
    fromwhere=${login_info[2]}
    if [[ $fromwhere =~ ^[A-Z] ]]; then
      hostname=$(curl -s ifconfig.io)
    else
      if [[ $fromwhere =~ ^tmux ]];then
        hostname=${fromwhere%.*}
        echo "here"
      fi
    fi
  fi
  auth_sock_symlink=${AUTHSOCK_PREFIX}_${username}_${fromwhere}
  echo ${auth_sock_symlink}
}

function fix_auth_sock {
  funcname="ssh-agent-fix-auth-sock"
  authsock_symlink=$(echo_auth_sock_symlink)
  if [ -L ${authsock_symlink} ]; then
    if [ -S ${authsock_symlink} ]; then
      info "[$funcname] INFO: a ssh-agent socket found ${authsock_symlink}."
      info "[$funcname] INFO: set SSH_AUTH_SOCK to ${authsock_symlink} "
      export SSH_AUTH_SOCK=${authsock_symlink}
      export AUTHSOCK_SYMLINK=${authsock_symlink}
    else
      info "[$funcname] INFO: ${authsock_symlink} found but link is dead..."
      newest_socket=$(find /tmp -name "ssh*" -type d 2>/dev/null|\
                      xargs -I{} find {} -name "agent*" -type s -readable -print0 |\
                      xargs -0 -I{} ls -alu --full-time {} |\
                      awk '{print $6"-"$7, $9}' |\
                      sed -e s/://g |\
                      sort -nr | head -n1 | cut -f 2 -d ' ')

      if [ ! -z "${newest_socket}" ]; then
        info "[$funcname] INFO: new socket found at '${newest_socket}'."
        info "[$funcname] INFO: re-linked it to ${authsock_symlink}"
        ln -snf "$newest_socket" ${authsock_symlink}
        export SSH_AUTH_SOCK=${authsock_symlink}
      fi
    fi
  elif [ -S "$SSH_AUTH_SOCK" ]; then
    case $SSH_AUTH_SOCK in
      /tmp/*/agent.[0-9]*)
        info "[$funcname] INFO: SSH_AUTH_SOCK=${SSH_AUTH_SOCK};"
        info "[$funcname] INFO: link it to ${authsock_symlink} and re-export;" 
        ln -snf "$SSH_AUTH_SOCK" ${authsock_symlink}
        export SSH_AUTH_SOCK=${authsock_symlink}
        ;;
      "${authsock_symlink}")
        info "[$funcname] INFO: ssh-agent authentication socket is already fixed. do nothing."
        ;;
    esac
  else
    info "[$funcname] ERROR: no socket found."
  fi
}

fix_auth_sock
