SSH_ENV="${HOME}/.ssh_environment"
SSHAGENT=/usr/bin/ssh-agent
SSHAGENTARGS="-s"

function start_agent {
  echo -n "Initialising new SSH agentâ€¦"
    ${SSHAGENT} ${SSHAGENTARGS} | sed 's/^echo/#echo/' > "${SSH_ENV}"
    echo succeeded
    chmod 600 "${SSH_ENV}"
    . "${SSH_ENV}" >/dev/null
    if [ $(find ${HOME}/.ssh -name "id_*" | wc -l) -gt 0 ]; then
      ssh-add $HOME/.ssh/id_*
    fi
}

# Source SSH settings, if applicable

if [ -f "${SSH_ENV}" ]; then
  . "${SSH_ENV}" >/dev/null
  cnt=$(ps -ef | grep "${SSH_AGENT_PID}" | awk '{print $8}' | grep "[/a-zA-Z0-9]*ssh-agent[ -s]*$" | wc -l)
  [ $cnt -eq 0 ] && start_agent;
  
  if [[ -z `ssh-add -l | grep "${HOME}/.ssh/id_"` ]]; then
    ssh-add $HOME/.ssh/id_*
  fi
else
    start_agent;
fi
